# =========================
# GLOBAL (http-level) CONFIG
# =========================

limit_req_zone $binary_remote_addr zone=qr_limit:10m rate=20r/s;

proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=menu_cache:50m
                 max_size=2g inactive=24h use_temp_path=off;

map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# =========================
# UPSTREAMS
# =========================
upstream app_4001 { server host.docker.internal:4001; }
upstream app_4002 { server host.docker.internal:4002; }
upstream app_4003 { server host.docker.internal:4003; }
upstream app_4004 { server host.docker.internal:4004; }
upstream app_4008 { server host.docker.internal:4008; }

# =========================
# HTTP -> HTTPS
# =========================
server {
  listen 80;
  server_name _;
  return 301 https://$host$request_uri;
}

# =========================
# HTTPS SERVER
# =========================
server {
  listen 443 ssl;
  http2 on;
  server_name _;

  ssl_certificate     /etc/nginx/certs/fullchain.pem;
  ssl_certificate_key /etc/nginx/certs/kerzz.com.key;

  ssl_protocols TLSv1.2 TLSv1.3;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  proxy_ssl_server_name on;
  proxy_ssl_verify off;

  gzip on;
  gzip_types application/json text/plain text/css application/javascript;
  gzip_min_length 1024;

  # -------------------------
  # Socket.IO (4001)
  # -------------------------
  location /socket.io/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering off;

    proxy_pass https://app_4001;
  }

  location = /manager { return 301 /manager/; }

  # ============================================================
  # Main Backend - /manager/* (CORS + API)
  # ============================================================
  location /manager/ {
    # Dosya yükleme limiti
    client_max_body_size 50M;
    client_body_buffer_size 10M;

    # OPTIONS preflight - nginx'te yanıtla
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' $http_origin;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, x-restaurant-id, x-lang, x-turnstile-token, Accept, Origin, X-Requested-With';
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Max-Age' 86400;
        add_header 'Content-Length' 0;
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        return 204;
    }

    # Backend'in CORS header'larını geçir
    proxy_pass_header Access-Control-Allow-Origin;
    proxy_pass_header Access-Control-Allow-Credentials;
    proxy_pass_header Access-Control-Expose-Headers;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    proxy_pass https://app_4001/;
  }

  location = /payment { return 301 /payment/; }

  # ============================================================
  # Payment Backend - /payment/* (CORS + API)
  # ============================================================
  location /payment/ {
    # OPTIONS preflight
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' $http_origin;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, x-restaurant-id, x-lang, Accept, Origin, X-Requested-With';
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Max-Age' 86400;
        add_header 'Content-Length' 0;
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        return 204;
    }

    proxy_pass_header Access-Control-Allow-Origin;
    proxy_pass_header Access-Control-Allow-Credentials;
    proxy_pass_header Access-Control-Expose-Headers;

    proxy_pass https://app_4002/;
  }

  # ============================================================
  # IMPORTANT: Realtime WebSocket for /ai/api/realtime/*
  # ============================================================
  location ^~ /ai/api/realtime/ {
    limit_req zone=qr_limit burst=100 nodelay;

    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering off;

    proxy_no_cache 1;

    proxy_cache_bypass 1;

    proxy_pass https://app_4003/api/realtime/;
  }

  location = /ai { return 301 /ai/; }

  # ============================================================
  # AI Gateway - /ai/* (SSE + CORS)
  # ============================================================
  location /ai/ {
    limit_req zone=qr_limit burst=100 nodelay;

    # Dosya yükleme limiti
    client_max_body_size 50M;
    client_body_buffer_size 10M;
    client_body_timeout 300s;

    # OPTIONS preflight
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' $http_origin;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, x-restaurant-id, x-lang, Accept, Origin, X-Requested-With';
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Max-Age' 86400;
        add_header 'Content-Length' 0;
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        return 204;
    }

    # Backend'in CORS header'larını geçir
    proxy_pass_header Access-Control-Allow-Origin;
    proxy_pass_header Access-Control-Allow-Credentials;
    proxy_pass_header Access-Control-Expose-Headers;

    # SSE için kritik ayarlar
    proxy_buffering off;
    proxy_cache off;
    proxy_set_header X-Accel-Buffering no;
    chunked_transfer_encoding on;

    # Timeout ayarları
    proxy_connect_timeout 120s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    proxy_pass https://app_4003/;
  }

  # -------------------------
  # OTA Bundles - Static files
  # -------------------------
  location /ota-bundles/ {
      alias /var/www/ota-bundles/;
      
      add_header Cache-Control "public, max-age=31536000, immutable";
      add_header Access-Control-Allow-Origin "*";
      add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
      
      try_files $uri =404;
  }

  location = /license { return 301 /license/; }

  # ============================================================
  # LICENSE API - /license/* (CORS + File Upload)
  # ============================================================
  location /license/ {
    # OPTIONS preflight
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' $http_origin;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, x-restaurant-id, x-lang, Accept, Origin, X-Requested-With';
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Max-Age' 86400;
        add_header 'Content-Length' 0;
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        return 204;
    }

    proxy_pass_header Access-Control-Allow-Origin;
    proxy_pass_header Access-Control-Allow-Methods;
    proxy_pass_header Access-Control-Allow-Headers;
    proxy_pass_header Access-Control-Allow-Credentials;
      
    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_connect_timeout 300s;
      
    client_max_body_size 100M;
    client_body_buffer_size 10M;
    client_body_timeout 300s;
      
    proxy_buffering on;
    proxy_request_buffering on;

    proxy_pass https://app_4004/;
  }
  
  # -------------------------
  # Docker Registry
  # -------------------------
  location /v2/ {
    client_max_body_size 0;
    chunked_transfer_encoding on;
    
    proxy_pass http://host.docker.internal:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    proxy_read_timeout 900s;
    proxy_send_timeout 900s;
  }

}

# =========================
# IO.KERZZ.COM (Kerzz Manager)
# =========================
server {
  listen 443 ssl;
  http2 on;
  server_name io.kerzz.com;

  ssl_certificate     /etc/nginx/certs/fullchain.pem;
  ssl_certificate_key /etc/nginx/certs/kerzz.com.key;
  ssl_protocols TLSv1.2 TLSv1.3;

  # Frontend static dosyaları
  root /var/www/io.kerzz.com;
  index index.html;

  # Gzip sıkıştırma
  gzip on;
  gzip_types application/json text/plain text/css application/javascript;
  gzip_min_length 1024;

  # ============================================================
  # API istekleri -> Backend (4008)
  # ============================================================
  location /api/ {
    # OPTIONS preflight
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' $http_origin;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, x-restaurant-id, x-lang, Accept, Origin, X-Requested-With';
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Max-Age' 86400;
        add_header 'Content-Length' 0;
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        return 204;
    }

    # Backend'in CORS header'larını geçir
    proxy_pass_header Access-Control-Allow-Origin;
    proxy_pass_header Access-Control-Allow-Credentials;
    proxy_pass_header Access-Control-Expose-Headers;

    # Dosya yükleme limiti
    client_max_body_size 50M;
    client_body_buffer_size 10M;

    proxy_pass http://app_4008;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }

  # ============================================================
  # Socket.IO WebSocket
  # ============================================================
  location /socket.io/ {
    proxy_pass http://app_4008;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering off;
  }

  # ============================================================
  # SPA fallback - tüm diğer istekler index.html'e yönlendirilir
  # ============================================================
  location / {
    try_files $uri $uri/ /index.html;
  }
}